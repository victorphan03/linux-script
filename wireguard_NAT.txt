# H∆∞·ªõng d·∫´n C·∫•u h√¨nh WireGuard VPN To√†n di·ªán (NAT & Split Tunneling)

T√†i li·ªáu n√†y h∆∞·ªõng d·∫´n chi ti·∫øt c√°ch thi·∫øt l·∫≠p WireGuard ƒë·ªÉ truy c·∫≠p c√°c thi·∫øt b·ªã trong m·∫°ng n·ªôi b·ªô (LAN) nh∆∞ NAS, Server, Camera t·ª´ xa, ƒë·ªìng th·ªùi v·∫´n gi·ªØ t·ªëc ƒë·ªô Internet b√¨nh th∆∞·ªùng cho c√°c t√°c v·ª• kh√°c (Youtube, Web...).

---

## üéØ M√¥ h√¨nh & M·ª•c ti√™u

* **Server (Armbian):** IP LAN `192.168.1.6`. ƒê√≥ng vai tr√≤ Gateway, s·ª≠ d·ª•ng NAT ƒë·ªÉ chuy·ªÉn ti·∫øp g√≥i tin t·ª´ VPN v√†o m·∫°ng LAN.
* **Client (Laptop/ƒêi·ªán tho·∫°i):** K·∫øt n·ªëi t·ª´ xa (qua 4G ho·∫∑c Wifi Cafe).
* **M·ª•c ti√™u (Split Tunneling - Chia lu·ªìng):**
    * Truy c·∫≠p ƒë∆∞·ª£c t√†i nguy√™n n·ªôi b·ªô (d·∫£i `192.168.1.x`).
    * Truy c·∫≠p Internet (Youtube, Facebook...) ƒëi tr·ª±c ti·∫øp qua m·∫°ng hi·ªán t·∫°i ƒë·ªÉ ƒë·∫°t t·ªëc ƒë·ªô cao nh·∫•t, kh√¥ng ƒëi v√≤ng qua VPN.

---

## PH·∫¶N 1: C·∫•u h√¨nh tr√™n Server (Armbian)

ƒê·ªÉ Server c√≥ th·ªÉ chuy·ªÉn ti·∫øp d·ªØ li·ªáu t·ª´ VPN sang m·∫°ng LAN, ch√∫ng ta c·∫ßn b·∫≠t **IP Forwarding** v√† c·∫•u h√¨nh **NAT (Masquerade)**.

### B∆∞·ªõc 1: B·∫≠t chuy·ªÉn ti·∫øp IP (IP Forwarding)

1.  M·ªü file c·∫•u h√¨nh h·ªá th·ªëng:
    ```bash
    sudo nano /etc/sysctl.conf
    ```
2.  T√¨m d√≤ng `net.ipv4.ip_forward=1`.
    * N·∫øu c√≥ d·∫•u `#` ·ªü ƒë·∫ßu, h√£y x√≥a d·∫•u `#` ƒëi.
    * N·∫øu ch∆∞a c√≥, h√£y th√™m d√≤ng n√†y v√†o cu·ªëi file:
    ```ini
    net.ipv4.ip_forward=1
    ```
3.  L∆∞u file (`Ctrl+O` -> `Enter` -> `Ctrl+X`).
4.  √Åp d·ª•ng c·∫•u h√¨nh ngay l·∫≠p t·ª©c:
    ```bash
    sudo sysctl -p
    ```

### B∆∞·ªõc 2: C·∫•u h√¨nh NAT trong WireGuard Server

Th√™m quy t·∫Øc t∆∞·ªùng l·ª≠a (iptables) v√†o file c·∫•u h√¨nh ƒë·ªÉ Server bi·∫øt c√°ch x·ª≠ l√Ω g√≥i tin ƒëi ra card m·∫°ng v·∫≠t l√Ω (`eth0`).

1.  M·ªü file c·∫•u h√¨nh WireGuard:
    ```bash
    sudo nano /etc/wireguard/wg0.conf
    ```
2.  Trong ph·∫ßn **`[Interface]`**, th√™m 2 d√≤ng `PostUp` v√† `PostDown` v√†o b√™n d∆∞·ªõi c√°c d√≤ng c√≥ s·∫µn.

    *N·ªôi dung file m·∫´u:*
    ```ini
    [Interface]
    Address = 10.66.66.1/24
    ListenPort = 51820
    PrivateKey = <Kh√≥a b√≠ m·∫≠t c·ªßa Server - Gi·ªØ nguy√™n>

    # --- TH√äM ƒêO·∫†N N√ÄY (NAT ra card m·∫°ng eth0) ---
    # L∆∞u √Ω: ƒê·∫£m b·∫£o t√™n card m·∫°ng l√† 'eth0' b·∫±ng l·ªánh 'ip a'. N·∫øu kh√°c, h√£y s·ª≠a l·∫°i.
    PostUp = iptables -A FORWARD -i %i -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
    PostDown = iptables -D FORWARD -i %i -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE
    # ---------------------------------------------
    ```

3.  L∆∞u file v√† tho√°t.

### B∆∞·ªõc 3: Kh·ªüi ƒë·ªông l·∫°i d·ªãch v·ª•
```bash
sudo systemctl restart wg-quick@wg0






## PH·∫¶N 2: C·∫•u h√¨nh tr√™n Client (Windows/Mobile)

ƒê√¢y l√† b∆∞·ªõc quy·∫øt ƒë·ªãnh ƒë·ªÉ m√°y t√≠nh "bi·∫øt ƒë∆∞·ªùng" ƒëi v√†o m·∫°ng LAN nh√† b·∫°n m√† kh√¥ng l√†m ch·∫≠m Internet.

### B∆∞·ªõc 1: Th√™m Tunnel v√† Ch·ªânh s·ª≠a
1.  M·ªü ·ª©ng d·ª•ng **WireGuard** tr√™n m√°y kh√°ch.
2.  Th√™m tunnel (Import file c·∫•u h√¨nh `.conf` ho·∫∑c d√°n n·ªôi dung c·∫•u h√¨nh client m·ªõi t·∫°o).
3.  Ch·ªçn tunnel v·ª´a th√™m v√† nh·∫•n n√∫t **Edit** (Ch·ªânh s·ª≠a).

### B∆∞·ªõc 2: T·∫Øt ch·∫∑n traffic (B·∫Øt bu·ªôc v·ªõi Windows)
T√¨m √¥ checkbox c√≥ t√™n:
* ‚¨ú **Block untunneled traffic (kill-switch)**



üëâ **B·∫ÆT BU·ªòC B·ªé T√çCH (Uncheck)** √¥ n√†y.

> **L√Ω do:** N·∫øu t√≠ch v√†o ƒë√¢y, Windows s·∫Ω ch·∫∑n m·ªçi k·∫øt n·ªëi kh√¥ng ƒëi qua VPN (bao g·ªìm Internet th∆∞·ªùng), g√¢y xung ƒë·ªôt v·ªõi c·∫•u h√¨nh chia lu·ªìng (Split Tunneling).

### B∆∞·ªõc 3: C·∫•u h√¨nh Split Tunneling (S·ª≠a AllowedIPs)
Trong ph·∫ßn n·ªôi dung c·∫•u h√¨nh **`[Peer]`**, s·ª≠a d√≤ng `AllowedIPs` th√†nh:

```ini
AllowedIPs = 10.66.66.0/24, 192.168.1.0/24